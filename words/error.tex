\documentclass[12pt]{article}
\usepackage{amsmath, amssymb}
\usepackage{bbold}

\newcommand{\T}{^{\mathrm{T}}}
\newcommand{\inv}{^{-1}}
\newcommand{\cov}[1]{C^\text{#1}}
\newcommand{\covtot}{C}
\newcommand{\y}[1]{y_{\text{#1}}}

\title{Error Computation for Emulation}

\begin{document}
\maketitle


% TODO: make _obs and _pred a command with mathrm
\section{Introduction}

Our goal is to compute the likelihood function used to estimate model parameters with our emulator.
The log-likelihood $\mathcal{L}$ can be defined as 
\begin{equation}
    %\mathcal{L} = -\frac{1}{2} (\y{pred} - \y{obs}) \cov^{-1} (\y{pred} - \y{obs})^T
    \mathcal{L} = -\frac{1}{2} \bigg( \frac{\y{pred} - \y{obs}}{\y{obs}} \bigg) \covtot\inv \bigg( \frac{\y{pred} - \y{obs}}{\y{obs}} \bigg)
\end{equation}
where $\covtot$ is the covariance matrix, and $y$ is the clustering statistic we are emulating.
We use $\y{obs}$ to mean the statistic computed on a mock or data. 
We use $\y{pred}$ to mean the emulator prediction for that statistic. 
We take $y$ to have $P$ dimensions (radial bins in our case), and $C$ to be a $P \times P$ matrix.

This document outlines how we compute this covariance matrix $\covtot$, as well as other error measurements used in our emulation procedure.

\section{Notation}
 
The test set contains mock catalogs with $C=7$ different cosmologies $c$. 
There are $B=5$ boxes (or realizations) $b$ for each cosmology. 
These are each populated with $H=100$ different halo occupation distribution (HOD) models $h$, the same 100 for each cosmology. 
(There are also 10 random seeds used per HOD, but for now we only use one. We'll worry about this later.)

All of the covariance matrices in this document are fractional errors.
This is consistent with our definition of the likelihood function, which uses the fractional error between the observation and the emulator prediction.
We note that generally, it is not obvious whether to divide the physical error by the observation or the prediction to obtain the fractional error.
In this case, the prediction is trained on many observations, so the observation $\y{obs}$ is the more well-measured quantity and we choose it for the denominator.
%To obtain the physical error, they must be multiplied by the observation. 

The statistic is computed on all $7 \times 5 \times 100 = 3500$ mocks. 
The statistic is averaged over the 5 boxes, so our final test set contains $N=700$ statistics. 
We will denote these with index $n$.

\section{Test set error}

The error on the test set is computed as follows. 
For each cosmology, compute the mean statistic over the boxes.
Compute the deviation from this mean for each of the boxes, defined as the fractional error between the box statistic and the mean statistic for that cosmology. 
Do this for every HOD. 
The test set error is the standard deviation of all of these deviations from the mean.

Breaking this down: For each cosmology and HOD, compute the mean statistic $\bar{y}_{c,h}$ of the $B$ boxes.
\begin{equation}
    \bar{y}_{c,h} = \frac{1}{B} \sum_b^B {y_{b,c,h}} \\
\end{equation}
For each cosmology and HOD, compute the deviations from the mean for each box $b$.
\begin{equation}
    d_{b,c,h} = \frac{ {y_{b,c,h} - \bar{y}_{c,h}} } {\bar{y}_{c,h}}
\end{equation}
Compute the covariance of all of the deviations form the mean.
\begin{equation}
    \cov{test} = \frac{1}{BCH-1} \sum_{b}^B \sum_{c}^C \sum_{h}^H d_{b,c,h} \cdot d_{b,c,h}\T
\end{equation}

$C^{test}$ is a matrix of size $P \times P$.
The square root of the diagonal of this matrix (a.k.a. the standard deviation) is used as an input to the Gassian Process to represent the error on the \emph{training set}. % is this correct?
We do this because have a better handle on this error, compared to using the training set, due to the multiple realizations of the test set.
We note that the procedure outlined here estimates the sample variance contribution to the error.
The random seeds we have not yet included estimate the shot noise contribution; we will update with this later.


\section{Emulator performance and error}

The overall emulator performance $\cov{perf}$ is defined as
\begin{equation}
    \cov{perf} = \cov{emu} + \cov{test}
\end{equation}

We obtain this with the covariance of the fractional error of the test set emulation:
% \begin{equation}
%     %\sigma_{perf} = \sqrt{ \sum_n^N \frac{\big( y_{n,pred}^2 - y_{n,obs}^2 \big)} {N}}
%     %\sigma_{perf} = \frac{1}{\sqrt{N}}\sum_n^N \sqrt{ \frac{ y_{n,pred} - y_{n,obs} } {y_{n,obs}}}
%     \sigma_{perf} =  \sqrt{ \frac{1}{N} \sum_n^N  \big( \frac{ y_{n,pred}^2 - y_{n,obs}^2 } {y_{n,obs}^2} \big)}
% \end{equation}
\begin{eqnarray}
    f_n = \frac{ y_{n,pred} - y_{n,obs} } {y_{n,obs}} \\
    \cov{perf} = \frac{1}{N-1} \sum_n^N f_n \cdot f_n\T
\end{eqnarray}

We care about the emulator error $\sigma_{emu}$ separately, so we use
\begin{equation}
    \cov{emu} = \cov{perf} - \cov{test}
\end{equation}

Both $\cov{emu}$ and $\cov{perf}$ are matrices of size $P \times P$.

\section{Measurement covariance}

The covariance between the bins of the statistic is obtained with the Minerva mock catalogs. 
We compute the statistic on $M=100$ Minerva mocks, which we index by $m$. 
The Minerva covariance matrix $\cov{minerva}$ is a $P \times P$ matrix, given by
\begin{equation}
\cov{minerva} = \frac{1}{N-1} \sum_m^M (y_{m} - \bar{y})(y_{m} - \bar{y})^T
\end{equation}

% The correlation matrix, or reduced covariance matrix, $R$ is the normalized covariance matrix, with elements
% \begin{equation}
% R_{pp'} = \frac{C_{pp'}}{\sqrt{ C_{pp} C_{p'p'}}} 
% \end{equation}

We combine these errors to obtain a final covariance matrix $\covtot$ for our likelihood.
% We denote the measurement covariance matrix $\cov{meas}$; this includes the covariance between bins in the Minerva mocks and in the test set.
%We need to multiply our test set fractional error $\sigma_{test}$ by the measured statistic on our data $\y{obs}$ to obtain the test set physical error before combining it with the correlation matrix.
% \begin{equation}
%     \mathcal{C}_{pp'}^{meas} = R_{pp'} (\sigma_{test,p}y_{obs, p}) (\sigma_{test,p'}y_{obs, p'})
% \end{equation}
% We assume the emulator error is independent of the measurement error, and there is no covariance of the emulator error between bins.
% Then the emulator covariance matrix $\mathcal{C}^{emu}$ is, once again multiplying our fractional error by the observed statistic,
% \begin{equation}
%     \mathcal{C}^{emu} = diag(\sigma_{emu}^2 y_{obs, p}^2)
% \end{equation}
The final covariance matrix is
\begin{equation}
    \covtot = \cov{minerva} + \cov{emu}
\end{equation}

% \begin{eqnarray}
% \sigma_{comb,p} &=& \sqrt{ \sigma_{test,p}^2 + \sigma_{emu,p}^2} \\
% \sigma_{comb,p'} &=& \sqrt{ \sigma_{test,p'}^2 + \sigma_{emu,p'}^2} \\
% \mathcal{C}_{pp'} &=& R_{pp'} (\sigma_{comb,p}y_{obs, p}) (\sigma_{comb,p'}y_{obs, p'})
% \end{eqnarray}

\end{document}